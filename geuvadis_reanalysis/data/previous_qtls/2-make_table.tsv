devtools::load_all("~/genomicRutils/")
library(tidyverse)

gencode_hla <- gencode_chr_gene %>%
  filter(gene_name %in% paste0("HLA-", c("A", "B", "C", "DQA1", "DQB1", "DRB1"))) %>%
  select(gene_id, gene_name)

gencode_hla_V12 <- 
  get_gencode_coords("~/gencode_data/gencode.v12.annotation.gtf.gz") %>%
  filter(gene_name %in% paste0("HLA-", c("A", "B", "C", "DQA1", "DQB1", "DRB1"))) %>%
  select(gene_id, gene_name)

qtls <- 
  "~/rnaseq/kallisto/QTLtools/permutations/conditional_60_all.txt.gz" %>%
  read_qtltools() %>%
  inner_join(gencode_hla, by = c("phen_id" = "gene_id")) %>%
  group_by(gene_name, rank) %>%
  mutate(pval_rank = min_rank(bwd_pval)) %>%
  select(phenotype = gene_name, rank, variant = var_id, 
	 significant = bwd_signif, pval_rank)

battle <- 
  readxl::read_excel("./battle_eqtls.xls", sheet = 1) %>%
  inner_join(gencode_hla, by = c("GENE_NAME" = "gene_name")) %>%
  select(phenotype = GENE_NAME, variant = SNP_ID) %>%
  mutate(variant = recode(variant, "rs9273448" = "rs1049225"),
         source = "Battle (2014)")

geuvadis_eur <- 
  "~/rnaseq/kallisto/QTLtools/rtc/EUR/geuvadis_eqtls/catalog.tsv" %>%
  read_tsv(col_names = FALSE) %>%
  separate(X2, c("junk1", "phenotype", "junk2"), sep = ":") %>%
  select(phenotype, variant = X1) %>%
  mutate(source = "Lappalainen (2013)")

barreiro <- 
  readxl::read_excel("./barreiro_eqtls.xlsx", 1, skip = 2) %>%
  select(phenotype = external_gene_name, variant = NI_top_snp_id) %>%
  filter(phenotype %in% gencode_hla$gene_name) %>%
  mutate(source = "Nedelec (2016)")

mary <- 
  tibble(phenotype = "HLA-C", variant = "rs2395471", source = "Vince (2016)")
 
qtls_df <-
  bind_rows(
    left_join(battle, qtls),
    left_join(geuvadis_eur, qtls),
    left_join(barreiro, qtls),
    left_join(mary, qtls)
  ) %>%
  select(source, phenotype, everything()) %>%
  arrange(source, phenotype)

write_tsv(qtls_df, "./previous_eQTLs.tsv")
