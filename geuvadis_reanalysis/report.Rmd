---
title: "Report"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, comment = "")
```

```{r pkgs, echo = FALSE}
library(knitr)
library(tidyverse)
```

# Typing accuracies

\*Concordance: the proportion of the called alleles that are concordant with the
Gourraud et al (2014) typings

```{r}
kallisto_typing <-
    read_tsv("./expression/kallisto/genotyping_accuracies_2.tsv") %>%
    select(locus, kallisto = accuracy)

star_typing <-
    read_tsv("./expression/star/genotyping_accuracies_2.tsv") %>%
    select(locus, star = accuracy)

left_join(star_typing, kallisto_typing, by = "locus") %>%
    mutate_at(vars(star, kallisto), function(x) x*100) %>%
    kable(digits = 2)
```

# Expression estimates

```{r}
include_graphics("./expression/plots/expression_boxplot.png")
```

## kallisto vs STAR-Salmon

### TPM

```{r}
include_graphics("./expression/plots/star_vs_kallisto_TPM.png")
```

### PCA-corrected

```{r}
include_graphics("./expression/plots/star_vs_kallisto_PCA.png")
```

## HLA diversity vs reference chromosomes only

### TPM

#### STAR

```{r}
include_graphics("./expression/plots/star_imgt_vs_pri_TPM.png")
```

#### kallisto

```{r}
include_graphics("./expression/plots/kallisto_imgt_vs_pri_TPM.png")
```

### PCA-corrected

#### STAR

```{r}
include_graphics("./expression/plots/star_imgt_vs_pri_PCA.png")
```

#### kallisto

```{r}
include_graphics("./expression/plots/kallisto_imgt_vs_pri_PCA.png")
```

## Distribution of TPM values

```{r}
include_graphics("./expression/plots/tpm_distributions.png")
```

## ASE 

### ASE by number of genotyping errors

\*Each point represents a heterozygous genotype in the intersect with Gourraud
data.

```{r}
include_graphics("./expression/plots/ase.png")
```

### ASE distribution

```{r}
include_graphics("./expression/plots/ase_histogram.png")
```

## Correlation of expression

```{r}
include_graphics("./expression/plots/correlation_decrease.png")
```

### Among the HLA genes

```{r}
include_graphics("./expression/plots/hlacorrelations.png")
```

### Between Class II genes and CIITA

```{r}
include_graphics("./expression/plots/trans_activ_corrs.png")
```

### Between pairs of HLA genes on the same vs on different haplotypes

#### HLA-A vs HLA-B

```{r}
include_graphics("./expression/plots/a_vs_b.png")
```

#### HLA-A vs HLA-C

```{r}
include_graphics("./expression/plots/a_vs_c.png")
```

#### HLA-B vs HLA-C

```{r}
include_graphics("./expression/plots/b_vs_c.png")
```

#### HLA-DQA1 vs HLA-DQB1

```{r}
include_graphics("./expression/plots/dqa_vs_dqb.png")
```

#### HLA-DQA1 vs HLA-DRB1

```{r}
include_graphics("./expression/plots/dqa_vs_drb.png")
```

# eQTLs

**All analyses were carried out using European individuals only**

## PCA of genotypes

```{r}
include_graphics("./qtls/plots/genotype_pca.png")
```

## Number of eGenes according to index

```{r}
include_graphics("./qtls/plots/n_of_egenes.png")
```

## Distribution of eQTLs around the TSS

### IMGT index

```{r}
include_graphics("./qtls/plots/qtls_landscape_imgt.png")
```

### Reference transcriptome

```{r}
include_graphics("./qtls/plots/qtls_landscape_pri.png")
```

## RTC between IMGT and Ref Transcriptome eQTLs

Variants with RTC > 0.9 likely mark the same biological signal.

```{r}
read_tsv("./qtls/qtls_star/imgt/rtc/pri_eqtls/results.tsv") %>%
    kable(digits = 2)
```

## Comparison with previous eQTLs

### eQTLs in regulomeDB

```{r}
read_tsv("./qtls/qtls_star/imgt/haploreg/regulomeDB_results.tsv") %>%
    select(gene, rank, rsid, score, qtl) %>%
    mutate(qtl = gsub("\\|", "_", qtl),
	   qtl = sub(";NA$", "", qtl)) %>%
    kable()
```

### eQTLs in HaploReg

```{r}
read_tsv("./qtls/qtls_star/imgt/haploreg/haploreg_results.tsv") %>%
    select(gene, rank, rsID, study, tissue, pvalue) %>%
    kable()
```

### eQTLs in GRASP (via HaploReg)

```{r}
read_tsv("./qtls/qtls_star/imgt/haploreg/grasp_results.tsv") %>%
    kable()
```

### RTC

Here we can see that, when our eQTLs were not previously described in the 
databases, they tag some eQTL in the database.

Most of them are tagging an eQTL from regulomeDB. I believe that's because, for
all sources not regulomeDB, I selected only the top variant for each tissue and 
gene. For regulomeDB that's no possible beucase the p-value is not directly 
available, so there are more variants per gene, which increases the chance that
some of these variants will have high RTC with one of our eQTLs.

```{r}
read_tsv("./qtls/qtls_star/imgt/rtc/previous_qtls/results.tsv") %>%
    kable(digits = 2)
```

## Association with GWAS traits

```{r}
read_tsv("./qtls/qtls_star/imgt/rtc/gwas/results.tsv") %>%
    select(gene, rank, variant, gwas_variant, rtc, trait, studies = link) %>%
    group_by(gene, rank, variant, gwas_variant, rtc) %>%
    summarize(trait = paste(trait, collapse = "/"), 
              studies = paste(studies, collapse = " ")) %>%
    kable(digits = 2)
```

# Trans-eQTLs

- Approximate pass as described on QTLtools website

```{r}
read_tsv("./qtls/qtls_star/imgt/trans/trans_results.tsv") %>%
    kable(digits = 2)
```

## HLA lineages

```{r}
include_graphics("./qtls/plots/lineage_and_effects.png")
```

### F-test: is there a difference between lineages?

#### traditional ANOVA

```{r}
read_tsv("./qtls/f_test_lineages.tsv") %>%
    mutate(p.value = format(p.value, digits = 3)) %>%
    select(locus, df, F, p.value) %>%
    kable(digits = 3)
```

#### Welch ANOVA

```{r}
read_tsv("./qtls/f_onewaytest_lineages.tsv") %>%
    mutate(p.value = format(p.value, digits = 3)) %>%
    kable(digits = 3)
```

